Author GORAV MADAN

Infrastructure Automation with Terraform & Ansible on Azure

Project Overview
This project automates the provisioning and configuration of Azure infrastructure using Terraform and Ansible, orchestrated via an Azure DevOps pipeline.
Terraform: Creates Azure resources — Resource Group, Virtual Network, Subnet, Public IP, NIC, and a Linux VM.
Ansible: Configures the VM (e.g., installs packages, services) using a playbook.
Azure DevOps Pipeline: Automates the entire workflow — installing tools, running Terraform, and applying Ansible configuration.

Repository Contents
Folder/File	Description
terraform/	Terraform configuration files
ansible/playbook.yml	Ansible playbook to configure the Azure VM
azure-pipelines.yml	Azure DevOps pipeline YAML file
README.md	This documentation

Prerequisites
Before running the pipeline, ensure:
Azure subscription with permissions to create resources.
Azure DevOps project with a service connection configured for your Azure subscription.
SSH key pair (private key uploaded as Azure DevOps Secure File).

The Terraform-SP-Creds variable group is created in Azure DevOps, containing the following secrets/variables:
ARM_CLIENT_ID
ARM_CLIENT_SECRET
ARM_SUBSCRIPTION_ID
ARM_TENANT_ID
ssh_public_key (public key string, non-secret)

Terraform Configuration
Uses azurerm provider to create:
Resource Group
Virtual Network & Subnet
Public IP
Network Interface (NIC)
Linux VM (RHEL/Azure-friendly image)
VM size and SSH public key are configurable via variables.

Outputs the VM's public IP for Ansible use.
Ansible Playbook
Located at ansible/playbook.yml.

Uses dynamic inventory generated by the pipeline from Terraform output.

Configures the VM by:
Installing necessary repos (EPEL, RHUI)
Installing nginx or any other required packages
Opening firewall ports as needed
Setting up and enabling services
Uses the SSH private key securely downloaded during pipeline execution.

Azure DevOps Pipeline
azure-pipelines.yml automates:

Installing Terraform CLI
Running terraform init, terraform plan, and terraform apply
Downloading SSH private key secure file
Installing Ansible using Python pip
Generating Ansible inventory from Terraform output (VM IP)
Running Ansible playbook against the provisioned VM

Pipeline variables:
terraform_folder: folder containing Terraform code
ansible_folder: folder containing Ansible playbook
location: Azure region for resources
vm_name: VM instance name
Requires the secure file id_rsa_azure to be uploaded in Azure DevOps for SSH access.

How to Run the Pipeline
Option A: Full Infra Provisioning + Configuration
Fork or clone the repo.

Ensure all variables and secure files are configured in your Azure DevOps project.
Push your code and trigger the pipeline.
The pipeline provisions Azure resources via Terraform.
Once resources are created, Ansible configures the VM automatically.
Verify VM by SSH using your private key and public IP output by Terraform.

Option B: Configure Existing VM (Skip Terraform)
If you already have the Azure VM and infrastructure:

Modify the pipeline YAML to comment out or remove Terraform tasks (init, plan, apply).

Manually provide these pipeline variables:
vm_public_ip (IP address of your existing VM)
ansible_user (SSH username)
ssh_key_path (path or secure file reference of your private SSH key)
Pipeline will generate inventory and run Ansible playbook using provided VM details.

Troubleshooting Tips
Ansible Package Issues: Ensure your VM has sufficient size and memory to install packages like nginx and EPEL repository.
Azure CLI Auth Errors: Ensure your service principal credentials are correct and have proper RBAC permissions.
Pipeline YAML Formatting: YAML syntax errors often come from improper indentation or misplaced multiline blocks. Use a YAML validator if needed.

Outputs
Terraform outputs the public IP of the VM for SSH and Ansible usage.
Pipeline logs show detailed info on each step, including Terraform and Ansible executions.
Ansible playbook logs show configuration status and any failures.
